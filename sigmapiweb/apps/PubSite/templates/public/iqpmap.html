{% extends 'public/_article_base.html' %}
{% block title %}Sigma Pi Gamma Iota - IQP Map{% endblock %}

{% load sass_tags %}
{% block article_includes %}
    {% load staticfiles %}
    <link href="{%sass_src 'css/public/map.scss'%}?v=1" rel="stylesheet">
{% endblock %}


{% block content_title %}
  IQP Map
{% endblock %}

{% block article %}

  <div class="container content-top-margin">
      <h2>Brothers Abroad</h2>
      <p>This is an interactive map of brothers who are currently on IQP.</p>

  </div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
   integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   crossorigin=""/>

   <!-- Make sure you put this AFTER Leaflet's CSS -->
   <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
     integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
     crossorigin=""></script>

  <div class="mapdiv", id="mapdiv">
    <script>
      let map = L.map('mapdiv', {
          zoom: 5,
          minZoom: 2,
          maxZoom: 18,
          maxBoundsViscosity: 1.0
          });

  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic2Rtb3JhbiIsImEiOiJjanU3dmg0dWUwcTNkNGRtZnZpcXhwNndoIn0.TWcmvvVgQMtHY-KR8nowSw', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    id: 'mapbox.streets'
    }).addTo(map);

  // List of locations
  var locations = [];

  // List of brothers at each location
  var brothers = [];

  // Takes list of brothers and locations from Django and puts them in a Javascript array. Locations and the brothers at
  // those locations have the same indices in each array.

  {% for b in brothers %}
    // Appends location information
    var loc = "{{ b.userinfo.iqpCity }}" + ", " + "{{ b.userinfo.iqpCountry }}";
    // If we already have brothers at this location, append current brother name to preexisting list of brothers at that
    // location.
    if(locations.includes(loc)) {
        var index = locations.indexOf(loc);
        var temp = brothers[index];
        temp += ", {{ b.first_name }}" + " " + "{{ b.last_name }}";
        brothers[index] = temp;
    }
    // Otherwise, just add a location and the brother at that location.
    else {
        locations.push(loc);
        brothers.push("{{ b.first_name }}" + " " + "{{ b.last_name }}");
    }
  {% endfor %}

  // Now we have a list of brothers at each location, accounting for duplicates.

  // For each location, get the coords and place a pin on the map with the names of each brother there at those coords.
  for(let i = 0; i < locations.length; i++) {
    const Http = new XMLHttpRequest();
    const url='https://nominatim.openstreetmap.org/search?q=' + locations[i] + '&format=json&limit=1';
    Http.open("GET", url);
    Http.send();
    Http.onreadystatechange=function() {
        if(this.readyState === 4) {
            cb(Http.responseText, i);
        }
    }
  }

  // Callback function that takes a JSON response containing lat and lon for a location and an index that indicates
  // which brothers/locations these coordinates refer to. This function places the actual pin on the map.
  function cb(json, i) {
      console.log(brothers);
      console.log(locations);
      console.log(i);
      json = JSON.parse(json);
      if (typeof json !== 'undefined') {
          L.marker([json[0].lat, json[0].lon]).addTo(map)
              .bindPopup('<b>' + brothers[i] + '</b><br>' + locations[i] + '</br>').openPopup();
      }
  }

  // Make map visible
  map.setView([0,-16.7699181], 2);
    </script>

  </div>
{% endblock %}